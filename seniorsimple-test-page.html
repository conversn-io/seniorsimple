<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeniorSimple Test Runner</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            background: #fafafa;
        }
        .test-button { 
            padding: 12px 24px; 
            margin: 8px; 
            background: #007cba; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 14px;
            transition: background 0.3s;
        }
        .test-button:hover { 
            background: #005a87; 
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .test-results { 
            margin-top: 15px; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 5px; 
            border-left: 4px solid #007cba;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; }
        .header {
            background: linear-gradient(135deg, #007cba, #005a87);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.running { background: #ffc107; color: #000; }
        .status.completed { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ SeniorSimple Test Runner</h1>
            <p>Automated testing for SeniorSimple tracking implementation</p>
            <div id="overall-status" class="status">Ready</div>
        </div>
        
        <div class="test-section">
            <h3>üéØ Test Controls</h3>
            <button class="test-button" onclick="runAllTests()" id="run-all-btn">Run All Tests</button>
            <button class="test-button" onclick="runBasicTracking()" id="basic-btn">Basic Tracking</button>
            <button class="test-button" onclick="runQuizCrawler()" id="crawler-btn">Quiz Crawler</button>
            <button class="test-button" onclick="runVerification()" id="verification-btn">Verification</button>
            <button class="test-button" onclick="runDiagnostics()" id="diagnostics-btn">Diagnostics</button>
            <button class="test-button" onclick="clearResults()" id="clear-btn">Clear Results</button>
        </div>
        
        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="test-results" class="test-results">
                <p class="info">Click a test button to run tests...</p>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîç Console Output</h3>
            <div id="console-output" class="test-results">
                <p class="info">Check browser console (F12) for detailed output...</p>
            </div>
        </div>

        <div class="test-section">
            <h3>üìã Manual Commands</h3>
            <p>You can also run these commands directly in the browser console:</p>
            <code>
                window.seniorSimpleAutoTests.runAllTests()<br>
                window.seniorSimpleAutoTests.runBasicTracking()<br>
                window.seniorSimpleAutoTests.runQuizCrawler()<br>
                window.seniorSimpleAutoTests.runVerification()<br>
                window.seniorSimpleAutoTests.runDiagnostics()
            </code>
        </div>
    </div>

    <script>
        // Test configuration
        const TEST_CONFIG = {
            baseUrl: window.location.href,
            testSessionId: `auto_test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            delayBetweenTests: 3000
        };

        // Utility functions
        function logTest(step, message, data = {}) {
            console.log(`‚úÖ [${step}] ${message}`, data);
            updateResults(`‚úÖ [${step}] ${message}`, 'success');
        }

        function logError(step, message, error = {}) {
            console.error(`‚ùå [${step}] ${message}`, error);
            updateResults(`‚ùå [${step}] ${message}`, 'error');
        }

        function logWarning(step, message, data = {}) {
            console.warn(`‚ö†Ô∏è [${step}] ${message}`, data);
            updateResults(`‚ö†Ô∏è [${step}] ${message}`, 'warning');
        }

        function logInfo(step, message, data = {}) {
            console.log(`‚ÑπÔ∏è [${step}] ${message}`, data);
            updateResults(`‚ÑπÔ∏è [${step}] ${message}`, 'info');
        }

        function updateResults(message, type = 'info') {
            const results = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            results.innerHTML += `<p class="${className}">[${timestamp}] ${message}</p>`;
            results.scrollTop = results.scrollHeight;
        }

        function updateStatus(status, className = '') {
            const statusEl = document.getElementById('overall-status');
            statusEl.textContent = status;
            statusEl.className = `status ${className}`;
        }

        function setButtonState(buttonId, enabled, text = null) {
            const btn = document.getElementById(buttonId);
            btn.disabled = !enabled;
            if (text) btn.textContent = text;
        }

        // Test functions
        async function runBasicTrackingTest() {
            logTest('Basic', 'Starting basic tracking test...');
            
            // Simulate DataLayer events
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'quiz_start',
                'quiz_type': 'annuity',
                'session_id': TEST_CONFIG.testSessionId,
                'funnel_type': 'annuity'
            });
            logTest('DataLayer', 'Quiz Start event pushed');

            // Simulate GA4 events
            if (typeof gtag !== 'undefined') {
                gtag('event', 'quiz_start', {
                    'quiz_type': 'annuity',
                    'session_id': TEST_CONFIG.testSessionId,
                    'funnel_type': 'annuity'
                });
                logTest('GA4', 'Quiz Start event sent');
            } else {
                logWarning('GA4', 'gtag not available - using GTM');
            }

            // Simulate Meta events
            if (typeof fbq !== 'undefined') {
                fbq('track', 'PageView');
                logTest('Meta', 'PageView event sent');
            } else {
                logWarning('Meta', 'fbq not available - using GTM');
            }

            logTest('Basic', 'Basic tracking test completed');
        }

        async function runQuizCrawlerTest() {
            logTest('Crawler', 'Starting quiz crawler test...');
            
            // Simulate quiz start
            window.quizStartTime = Date.now();
            window.dataLayer.push({
                'event': 'quiz_start',
                'quiz_type': 'annuity',
                'session_id': TEST_CONFIG.testSessionId,
                'funnel_type': 'annuity'
            });
            logTest('Crawler', 'Quiz start simulated');

            // Simulate question answers
            const questions = [
                { number: 1, text: 'Do you have $100,000+ in investable assets?', answer: 'Yes, I have $100,000 or more' },
                { number: 2, text: 'How soon are you planning to retire?', answer: 'Within 1-2 years' },
                { number: 3, text: 'What type of retirement plans?', answer: '401k, IRA' },
                { number: 4, text: 'How much saved for retirement?', answer: '$750,000 - $999,999' },
                { number: 5, text: 'What is your risk tolerance?', answer: 'Moderate' }
            ];

            for (const question of questions) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                window.dataLayer.push({
                    'event': 'question_answer',
                    'question_number': question.number,
                    'question_text': question.text,
                    'answer_value': question.answer,
                    'session_id': TEST_CONFIG.testSessionId,
                    'funnel_type': 'annuity'
                });
                logTest('Crawler', `Question ${question.number} answered`);
            }

            // Simulate quiz completion
            const completionTime = Date.now() - window.quizStartTime;
            window.dataLayer.push({
                'event': 'quiz_complete',
                'quiz_type': 'annuity',
                'session_id': TEST_CONFIG.testSessionId,
                'funnel_type': 'annuity',
                'completion_time': completionTime,
                'lead_score': 85
            });
            logTest('Crawler', 'Quiz completed');

            // Simulate lead form submission
            window.dataLayer.push({
                'event': 'lead_form_submit',
                'event_category': 'lead_generation',
                'event_label': 'SeniorSimple Medicare Quiz',
                'value': 1,
                'session_id': TEST_CONFIG.testSessionId,
                'funnel_type': 'annuity',
                'lead_score': 85
            });
            logTest('Crawler', 'Lead form submitted');

            logTest('Crawler', 'Quiz crawler test completed');
        }

        async function runVerificationTest() {
            logTest('Verification', 'Starting verification test...');
            
            // Check tracking systems
            const systems = {
                gtm: typeof window.google_tag_manager !== 'undefined',
                ga4: typeof gtag !== 'undefined',
                meta: typeof fbq !== 'undefined',
                dataLayer: Array.isArray(window.dataLayer)
            };

            Object.entries(systems).forEach(([system, loaded]) => {
                if (loaded) {
                    logTest('System', `${system.toUpperCase()} loaded`);
                } else {
                    logWarning('System', `${system.toUpperCase()} not loaded (via GTM)`);
                }
            });

            // Check fired events
            const dataLayerEvents = window.dataLayer?.filter(item => item.event) || [];
            logTest('Verification', `DataLayer events: ${dataLayerEvents.length}`);
            
            dataLayerEvents.forEach(event => {
                logTest('Event', `${event.event} fired`);
            });

            logTest('Verification', 'Verification test completed');
        }

        async function runDiagnosticsTest() {
            logTest('Diagnostics', 'Starting diagnostics test...');
            
            // Check GTM
            const gtmScript = document.querySelector('script[src*="googletagmanager.com"]');
            if (gtmScript) {
                logTest('Diagnostics', 'GTM script found');
            } else {
                logError('Diagnostics', 'GTM script not found');
            }

            // Check GA4
            const ga4Script = document.querySelector('script[src*="googletagmanager.com/gtag/js"]');
            if (ga4Script) {
                logTest('Diagnostics', 'GA4 script found');
            } else {
                logWarning('Diagnostics', 'GA4 via GTM');
            }

            // Check Meta
            const metaScript = document.querySelector('script[src*="facebook.com/tr"]');
            if (metaScript) {
                logTest('Diagnostics', 'Meta Pixel script found');
            } else {
                logWarning('Diagnostics', 'Meta via GTM');
            }

            // Check network requests
            const networkRequests = performance.getEntriesByType('resource');
            const trackingRequests = networkRequests.filter(req => 
                req.name.includes('googletagmanager.com') || 
                req.name.includes('facebook.com') ||
                req.name.includes('google-analytics.com')
            );
            logTest('Diagnostics', `Tracking requests: ${trackingRequests.length}`);

            logTest('Diagnostics', 'Diagnostics test completed');
        }

        // Main test runner
        async function runAllTests() {
            updateStatus('Running All Tests', 'running');
            setButtonState('run-all-btn', false, 'Running...');
            
            logTest('TestRunner', 'Starting all tests...');
            console.log('Test Session ID:', TEST_CONFIG.testSessionId);
            
            try {
                await runBasicTrackingTest();
                await new Promise(resolve => setTimeout(resolve, TEST_CONFIG.delayBetweenTests));
                
                await runQuizCrawlerTest();
                await new Promise(resolve => setTimeout(resolve, TEST_CONFIG.delayBetweenTests));
                
                await runVerificationTest();
                await new Promise(resolve => setTimeout(resolve, TEST_CONFIG.delayBetweenTests));
                
                await runDiagnosticsTest();
                
                logTest('TestRunner', 'All tests completed successfully!');
                updateStatus('All Tests Completed', 'completed');
                
            } catch (error) {
                logError('TestRunner', 'Test execution failed', error);
                updateStatus('Test Failed', 'error');
            } finally {
                setButtonState('run-all-btn', true, 'Run All Tests');
            }
        }

        // Individual test functions
        async function runBasicTracking() {
            setButtonState('basic-btn', false, 'Running...');
            try {
                await runBasicTrackingTest();
                setButtonState('basic-btn', true, 'Basic Tracking');
            } catch (error) {
                logError('Basic', 'Test failed', error);
                setButtonState('basic-btn', true, 'Basic Tracking');
            }
        }

        async function runQuizCrawler() {
            setButtonState('crawler-btn', false, 'Running...');
            try {
                await runQuizCrawlerTest();
                setButtonState('crawler-btn', true, 'Quiz Crawler');
            } catch (error) {
                logError('Crawler', 'Test failed', error);
                setButtonState('crawler-btn', true, 'Quiz Crawler');
            }
        }

        async function runVerification() {
            setButtonState('verification-btn', false, 'Running...');
            try {
                await runVerificationTest();
                setButtonState('verification-btn', true, 'Verification');
            } catch (error) {
                logError('Verification', 'Test failed', error);
                setButtonState('verification-btn', true, 'Verification');
            }
        }

        async function runDiagnostics() {
            setButtonState('diagnostics-btn', false, 'Running...');
            try {
                await runDiagnosticsTest();
                setButtonState('diagnostics-btn', true, 'Diagnostics');
            } catch (error) {
                logError('Diagnostics', 'Test failed', error);
                setButtonState('diagnostics-btn', true, 'Diagnostics');
            }
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '<p class="info">Results cleared...</p>';
            updateStatus('Ready', '');
        }

        // Global functions for buttons
        window.runAllTests = runAllTests;
        window.runBasicTracking = runBasicTracking;
        window.runQuizCrawler = runQuizCrawler;
        window.runVerification = runVerification;
        window.runDiagnostics = runDiagnostics;
        window.clearResults = clearResults;

        // Export for manual testing
        window.seniorSimpleAutoTests = {
            runAllTests: runAllTests,
            runBasicTracking: runBasicTracking,
            runQuizCrawler: runQuizCrawler,
            runVerification: runVerification,
            runDiagnostics: runDiagnostics,
            config: TEST_CONFIG
        };

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            logInfo('TestRunner', 'Page loaded, ready for testing...');
            logInfo('TestRunner', `Test Session ID: ${TEST_CONFIG.testSessionId}`);
        });

        console.log('üéØ SeniorSimple Test Runner loaded!');
        console.log('üéØ Available functions:');
        console.log('   - runAllTests()');
        console.log('   - runBasicTracking()');
        console.log('   - runQuizCrawler()');
        console.log('   - runVerification()');
        console.log('   - runDiagnostics()');
        console.log('   - window.seniorSimpleAutoTests.*');
    </script>
</body>
</html>
